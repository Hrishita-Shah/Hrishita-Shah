# .github/workflows/update-readme-stats.yml
name: Update GitHub Stats (Secure)

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # Use built-in token (repository-scoped, safer)
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Enable private contributions in profile
      run: |
        echo "💡 To show private contributions:"
        echo "1. Go to your GitHub profile settings"
        echo "2. Check 'Private contributions' option"
        echo "3. This shows private activity in your contribution graph"
        
    - name: Update README with GitHub Stats
      run: |
        echo "🔄 Updating GitHub stats (public repos only for security)..."
        
        # Check if markers exist
        if ! grep -q "<!-- GITHUB-STATS:START -->" README.md; then
          echo "❌ Error: Please add <!-- GITHUB-STATS:START --> and <!-- GITHUB-STATS:END --> markers"
          exit 1
        fi
        
        # Create backup
        cp README.md README.md.backup
        
        # Create secure stats content (no tokens in URLs)
        cat > new_stats.txt << 'EOF'
        <!-- GITHUB-STATS:START -->
        📊 **GitHub Stats:**
        <p>
          <img align="left" src="https://github-readme-stats.vercel.app/api/top-langs?username=Hrishita-Shah&show_icons=true&locale=en&layout=compact&theme=tokyonight" alt="Top Languages" />
        </p>
        <p>
          <img align="centre" src="https://github-readme-stats.vercel.app/api?username=Hrishita-Shah&show_icons=true&theme=tokyonight&include_all_commits=true" alt="Hrishitas GitHub Stats" />
        </p>
        <div align="center">
          <img src="https://github-readme-streak-stats.herokuapp.com/?user=Hrishita-Shah&theme=tokyonight" alt="GitHub Streak" />
        </div>
        
        > 💡 **Note**: Enable "Private contributions" in your GitHub profile settings to show private repository activity in your contribution graph.
        <!-- GITHUB-STATS:END -->
        EOF
        
        # Replace content between markers
        awk '
        /<!-- GITHUB-STATS:START -->/ {
          print
          system("cat new_stats.txt | tail -n +2 | head -n -1")
          skip = 1
          next
        }
        /<!-- GITHUB-STATS:END -->/ {
          skip = 0
          print
          next
        }
        !skip { print }
        ' README.md > README_temp.md
        
        mv README_temp.md README.md
        rm -f new_stats.txt
        
        echo "✅ Stats updated securely (no tokens exposed)"
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet README.md; then
          echo "📊 No changes detected"
        else
          echo "📝 Committing changes..."
          git add README.md
          git commit -m "🔄 Update GitHub stats [skip ci]"
          git push
          echo "✅ Updated successfully!"
        fi
        
        rm -f README.md.backup
